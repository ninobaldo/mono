% PLURAL DE HASH EH HASHS OU HASHES

\chapter{Antiforense com Rootkits}

Quando o perito vai realizar a coleta do material para a análise, ele pode encontrar dois cenários o corpo de delito que na ciência forense computacional quase sempre consiste em computadores,  pode estar ligado ou desligado. 
Quando o mesmo está ligado é possível realizar a análise viva, entretando a análise \emph{live} de um ambiente com rootkit pode gerar dados falsos ou imprecisos.

Análise \emph{live} ou análise viva, consiste em uma análise focada em extrair e examinar dados volatéis \cite{MCDOUGAL2006}, esses dados volatéis são perdidos ao desligar o computador, como por exemplo, o contéudo de registradores do processador, dados na \emph{cache}, dados na memória etc. 
Essa abordagem possui diversas vantagens entre elas estão extração de dados voláteis como já citado, triagem de equipamentos, triagem de dados, preservação de dados criptografado e a possiblidade de estabelecer flagrante \cite{FBC2011}.

É importante ressaltar que toda ferramenta ou \emph{hardware} utilizado para a coleta de dados em equipamentos que ainda estão em execução, vai depender de dados fornecidos pelo equipamento periciado, ou seja, em algum momento essas ferramentas forenses vão requisitar dados de um sistema comprometido e passível de alguma interceptação mesmo quando a solução utilizada para coleta é um hardware \cite{JORUT2007}. 
Logo em um ambiente dominado por um rootkit não é um ambiente confiável, pois ele pode interceptar e alterar chamadas das ferramentas de análise, impossibilitando uma coleta real e fiel.

A metodologia empregada na análise de um ambiente supostamente com um rootkit varia muito, mas em termos gerais a análise \emph{Post mortem} é menos arriscada e indicada para casos de rootkits. 
As medidas antiforense que podem ser tomadas pelo rootkit dependem do ambiente de execução e engloba também a equipe que o administra. No melhor dos cenários para o atacante é quando o sistema é administrado por leigos, não capacitados, sobrecarregados e/ou os sistemas não são atualizados com frequencia tornando mais fácil para o rootkit esconder-se exigindo menos do atacante. 
No pior dos cenários o administradores são altamente qualificados, realizam rotinas frequentes, esta sempre atualizado e é auditorado \cite{BH2009}. 
Entender isso pode indicar ao perito o quão complexo o rootkit é, pois quanto mais próximo do pior cenário mais avançado tem que ser o rootkit o que pode caracterizar um \emph{Advanced persistent threat (APT)} ou ameaça avançada e persistente, ou seja, o ataque utilizando o rootkit foi orquestrado e planejado apenas para esse alvo específico.

Não existe técnica 100\% antiforense, então o objetivo do atacante é tornar a análise cansativa para induzir ao erro podendo adicionar inclusive falsos rootkits ou malwares para despistar, iludir ou levar a conclusões precipitadas. Em \cite{BH2009} são mostrados passos para a análise \emph{Post mortem} onde se suspeita de rootkit: 

\begin{itemize}
  \item Clone do \emph{hard disk drive (HDD)};
  \item Recuperar arquivos;
  \item Coletar metadados dos arquivos;
  \item Retirar arquivos conhecidos;
  \item Análise estática dos executáveis suspeitos desconhecidos; e
  \item Análise dinâmica dos executáveis suspeitos.
\end{itemize}

Esses passos pode ser vistos como filtros, onde cada passo retira cada vez mais ruído, eliminando em cada etapa arquivos superfulos. A seguir serão descritos cada um dos passos e alguns dos problemas que o mesmo pode gerar.

\section{Cópia forense do HDD}

A primeira fase e mais importante é a coleta, que nesse caso é clone do HDD. O clone do HDD, pode ser feito com software, como o dd\footnote{http://pubs.opengroup.org/onlinepubs/9699919799/utilities/dd.html} ou por hardware específico para clonagem de HDDs. Por via de regra essas ferramentas são homologados por órgãos como \emph{National Institute of Standards and Technology (NIST)} que atestam a qualidade e eficácia dessas ferramentas em produzir cópias fidedignas que podem ser usadas em disputas legais como evidências. 
Basicamente todos essas ferramentas fazem cópias de setor por setor de todo o disco, para que o perito possa trabalhar nessa cópia preservando o HDD original. Essas cópias já foram exaustivamente usadas em tribunais e são muito úteis e indispensáveis para a análise do perito. 
Hoje sua eficácia não é questionada, pois essa cópia ou clone tem os dados idênticos ao do HDD objeto de análise e essa igualdade pode ser atestada com \emph{checksums} como os algoritmo de \emph{hash} \emph{MD5} ou \emph{SHA1} \cite{MULVEY2007}. Essa abordagem pode ter alguns empecilhos e o rootkit pode não vir a ser clonado junto com os dados do HDD.

Primeiro e mais óbvio é que o rootkit pode nem estar no disco clonado, como estar somente na memória ou ser alocado em um outro dispositivo. O rootkit poder ser projetado para ficar somente na memória, entretando isso pode impedir que o mesmo persista já que é apagado sempre que o computador desliga \cite{PAROS2009}.
Contudo o mesmo esteja num parque de máquinas que permita infectar o computador toda vez que este for iniciada, como em grandes \emph{data centers} em geral nunca tem todas as máquinas desligadas o rootkit pode ficar vivo na rede e persistir infectando novamente as máquinas assim que elas iniciarem. 

Num \emph{Personal Computer (PC)} durante o \emph{boot} ele inicia o \emph{Basic Input/Output System (BIOS)} fornece suporte básico para os principais periféricos como teclado e vídeo em modo texto e inicia o \emph{Power-On Self-Test (POST)} que além de realizar alguns testes inicia, com base das configurações do SETUP salvas na memória CMOS, todos os circuitos perífericos, vídeo, Sistema Operacional e passa o controle para o sistema operacional \cite{TORRES2001}. 
Durante todo esse processo o computador é executado em \emph{Real Mode}, e como já foi descrito anteriormente, em modo real os programas não são isolados uns dos outros como no \emph{Protected Mode}, logo qualquer programa em execução pode acessar todo conteúdo na memória. 
O rootkit pode persistir no \emph{firmware}\footnote{Todo programa salvo numa \emph{Read-only memory (ROM)} é chamado de firmware} de algum periférico, como a placa de vídeo \cite{NICDI2012} ou placa de rede \cite{ABME2012}, dessa forma que tornariam o clone do HDD inútil além de ter acesso em \emph{Real Mode} na inicialização do computador.

O perito deve ter em mente ainda que o rootkit pode estar em áreas reservadas do disco como \emph{host protected area (HPA)} ou \emph{Device configuration overlay (DCO)}, essas areas são desenvolvidas para não serem modificadas ou mesmo acessadas por usuários, BIOS ou Sistema Operacional \cite{MMMP2006}. 
Dessa forma dependendo da ferramenta utilizada para clone do HDD pode ser que essas áreas não sejam clonadas (\cite{NIJENC2006} ou \cite{NIJFTK2006}), inutilizando o clone do HDD.

Com o disco clonado o perito deve se ater a outros fatores, como criptografia, arquivos salvos em estruturas não convencionais etc. 
O disco clonado pode ter \emph{full disk encryption} o que significa que todos os dados no disco estão criptografados \cite{RUBENS2012} e que ao clonar o clone, como é uma cópia fidedigna do original, também tem todos os dados criptografados. 
Logo o disco deverá ser decriptado antes da análise. É improvável que um rootkit criptografe todo o disco da vítima, pois chamaria muita atenção e iria de encontro a uma de suas premissas que é se ocultar no sistema. 
Então quando disco está encriptado, ele provavelmente foi feito pela vítima e consequentimente a maior interessada no trabalho do perito facilitando a decriptação do disco. O mais comum nesses casos quando envolve criptografia é do rootkit encriptar somente o seu binário, mas isso vai ser discutido adiante na análise estática.

\section{Recuperar arquivos}

O próximo passo a ser tomado deve ser recuperar todos os arquivos do disco, isso incluí todos os arquivos \emph{Master Table File (MFT)} deletados ou não, seguido por \emph{data carving} com especial preocupação com: 

\begin{itemize}
  \item Assinaturas de executáveis;
  \item Fragmentos de arquivos;
  \item Data streams alternativos; e
  \item Slack space;
\end{itemize}

% Assinaturas de binários
Todos os arquivos tem um especificação que define o formato que o arquivo deve ter para ser corretamente interpretado, essas especifição define um padrão de como o \emph{bits} são organizados internamente e é chamado de \emph{file format} \cite{ROUSE2005}. 
Esse formato também é usado por ferramentas de \emph{data carving} para encontrar arquivos. Por exemplo a especificação do \emph{Portable Executable (PE) File Format} \cite{MS2013} determina que todos os programas comecem com um pequeno executável \emph{MS-DOS}. Esse pequeno executável inicia com o \emph{Magic Number} 0x5A4D ou \emph{MZ} em \emph{ASCII},as iniciais de Mark Zbikowski um dos arquitetos originais do MS-DOS \cite{PIETREK2002}, e uma mensagem como pode ser vista na figura \ref{fig:cal-hex}. A função desse pequeno programa é apresentar a mensagem ``This program cannot be run in DOS mode''. 

\begin{figure}[htb]
  \centering
  \includegraphics[scale=1]{figuras/cal-hex.png}
  \caption{Hexadecimal da Microsoft Calculator v. 5.1 visto no WinHex 16.3 SR-2}
  \label{fig:cal-hex}
\end{figure}

Programas que fazem \emph{data carving} buscam essas estruturas definidas, para encontrar executáveis. Contudo o rootkit pode usar programas como o \emph{Transmogrify} do \emph{Metasploit Anti-Forensics Project (MAFIA)} que é capaz de mascarar um arquivo em qualquer assinatura \cite{MAYNOR2007}, de forma a deixar um executável no formato de um arquivo texto por exemplo.

Outra forma do rootkit esconde-se de um \emph{data carving} é utilizando-se de uma organização de arquivo não convencional, como usar fragmentos de diversos arquivos que só fazem sentido quando organizados de determinada forma, salvar seus arquivos em slack space buscando e indexando-os em um \emph{file system} próprio \cite{CHUCK2007}, ou ainda usando \emph{features} de um sistema de arquivos como as \emph{streams} do NTFS \cite{IRBY2006}. 
Entretando por mais eficinte que seja o método utilizado, o rootkit em algum momento tem que executar, logo em algum ponto o rootkit tem que trabalhar com estruturas convencionais para que o sistema operacional o interprete, mesmo que seja apenas um \emph{stub} (ver análise estática).

\section{Coletar metadados dos arquivos}

Nessa etapa é feita a coleta dos metadados de todos os arquivos, segue os principais:

\begin{itemize}
  \item Hash;
  \item MAC time;
  \item Localização completa do arquivo em disco (\emph{Path}); e
  \item Nome;
  \item Tamanho;
\end{itemize}

É importante que se tenha ao menos esses metadados dos arquivos recuperados. Os próximos passos podem depender de um desses elementos. O \emph{hash} é fundamental para o próximo passo, o tamanho vai ser abordado na análise estática, o nome e \emph{path} são obviamente para sua identificação e para localização, e o \emph{MAC (Modify, Access, Create) time} pode vir a ser utilizado para desenvolver uma  \emph{timeline}, ferramenta útil e poderosa para favor do perito.

A análise da \emph{timeline} é um importante passo para todo processo tradicional de investigação, com base nela um perito forense computacional pode extrair informações cruciais para o caso \cite{KRISTINN2010}. Criar uma \emph{timeline} de eventos com base nos \emph{MAC time} dos arquivos ajuda a entender o ciclo de contaminação, além de levantar suspeitas sobre varios dados inconsistentes, como por exemplo, porque o papel de parede do Windows tem a data de modificação ou criação recente? Além de ajudar a entender como o rootkit pode ter se mantido no ambiente analisado. Dessa forma é possível recriar a cadeia de eventos gerando ao mesmo tempo contexto.

\begin{figure}[htb]
  \centering
  \includegraphics[scale=1]{figuras/Timestomp_mace.jpg}
  \caption{Arquivo com MAC time original \cite{IMGTIMEMC1}}
  \label{fig:timestomp_mace}
\end{figure}

Para \cite{HALL2011} um dos principais desafios na análise de \emph{timeline} envolve a fácil manipulação. Para não levantar suspeitas, ou dificultar o processo de análise da \emph{timeline}, o rootkit pode ser programado a alterar o \emph{MAC time} quando necessário. O programa \emph{Timestomp} também do \emph{MAFIA} e hoje integrado ao \emph{Meterpreter} é capaz de alterar esses metadados como é mostrado na figura \ref{fig:Timestomp_mace_change}.

\begin{figure}[htb]
  \centering
  \includegraphics[scale=1]{figuras/Timestomp_mace_change.jpg}
  \caption{Utilização do timestomp \cite{IMGTIMEMC2}}
  \label{fig:Timestomp_mace_change}
\end{figure}

%  outras referencias
% http://www.docstoc.com/docs/28703705/toorcon_vinnie_2005 timestomp
% http://www.ethicalhacker.net/forum/index.php?topic=5450.0;wap2
% http://www.explorehacking.com/2011/03/metasploit-tutorial-with-example.html

\section{Retirar arquivos conhecidos}

No passo anterior foram retirados \emph{hashes} dos arquivos encontrados e eles podem ser comparados com bases de hashes conhecidos, como os fornecidos pelo \emph{National Software Reference Library (NSRL)} \footnote{http://www.nsrl.nist.gov/Downloads.htm} fornecidos pelo NIST. Comparando os hashes dos arquivos com essas bases é possível retirar todos os arquivos conhecidos que são seguros, como arquivos do sistema operacional e também arquivos conhecidamente maliciosos diminindo o escopo que o perito deve trabalhar.

Para evitar ou atrapalhar esse processo o rootikit teria que ter o mesmo hash de um arquivo bom, o que é muito difícil....

a probabilidade de uma colisao de hash é de ... segundo FULANO usando a formula ........
% probabilidade (fazer tabela) http://preshing.com/20110504/hash-collision-probabilities 

mas nao impossivel ja que o MD5 foi quebrado ....
% http://www.mscs.dal.ca/~selinger/md5collision/ MD5 collision



base de hash de arquivos conhecidos bons e ruins (assinatura de malwares conhecidos);
% alterar partes nao significantes de todos os arquivos do computador, como a mensagem ja mostrada do PE alterar uma letra dessa mensagem muda o hash do mesmo cansando o perito :P, mas isso fugirira de uma regra basica dos rootkits FICAR INDECTETAVEL

\section{Análise estática dos executáveis suspeitos desconhecidos}

suspeitad do tamanho do arquivo jpg com 2GB, estegnografia

cryptors e packers. colocar o binário numa forma encriptado e comprimido que as tools nao interpretam, o stub (esbolço) decodifica o payload e munda o controle do executável para o entry point do binario original. usado pelo skype (http://www.blackhat.com/presentations/bh-europe-06/bh-eu-06-biondi/bh-eu-06-biondi-up.pdf) 

UPX \_ merge secxtions (.text, .data, .idata, etc) em um unico sectior upx1, onde tem uma stub que unpack o original.


funcionamento do upx

com a toool dumpbin da para ver as sections do upx

upx0 é espaço vazio
upx1 onde esta o stub e o executavel compactado, ao descompactar o executavel ele move para os endereços do upox (na low memory), assim o mesmo é decompoilado e executado e com o tempo ele sobreescreve tbm os endereços onde atnes estavam o upx1 (http://upx.sourceforge.net/)

embebed virtual machine, o rootkit esta em bytecode que sao interpretados pela vm em runtime, a tool nem mesmo o processador tem como saber como interpretar o bytecode sem a vm

compinação de ambos o stub decodifica a vm que interpreta o bytecode


basicamente o stub tem a chave para decodificar o binario, mas isso pode ser mais dificil quando crypter e packer privado, pode dividir o codigo em diversos setores e cada setor ter uma chave criptogradada diferente SALT + HWID + TIME + PCI\_ROM para criar a chave

% Criptografados : http://www.markus-gattol.name/ws/dm-crypt_luks.html


\section{Análise dinâmica dos executáveis suspeitos}


antidebugger FS flag determina o debug na arquitetura IA32, explicar que assim e processador faz uma instrução por vez


Windows SDK duas rotinas, WINAPI isDEBUggerPresent(void) user-mode ou KdRefreshDebuggerNotPresent() Kernel-mode (being debugged PEB http://www.symantec.com/connect/articles/windows-anti-debug-reference

antivirtualização, para testar qualquer código malicioso deve-se

http://www.chmag.in/article/sep2011/rootkits-are-back-boot-infection


\section{outro}





nao existe tecnica antiforense 100\% nem metodologia para analise infalivel, nem 100\% segura e confiavel


